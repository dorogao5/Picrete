services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    network_mode: host
    environment:
      - FIRST_SUPERUSER_ISU=${FIRST_SUPERUSER_ISU}
      - FIRST_SUPERUSER_PASSWORD=${FIRST_SUPERUSER_PASSWORD}
      - PICRETE_ENV=${PICRETE_ENV}
      - PICRETE_STRICT_CONFIG=${PICRETE_STRICT_CONFIG}
      - POSTGRES_SERVER=localhost
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - REDIS_HOST=localhost
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - SECRET_KEY=${SECRET_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL}
      - AI_MODEL=${AI_MODEL}
      - AI_MAX_TOKENS=${AI_MAX_TOKENS}
      - AI_TEMPERATURE=${AI_TEMPERATURE}
      - AI_REQUEST_TIMEOUT=${AI_REQUEST_TIMEOUT}
      - BACKEND_CORS_ORIGINS=${BACKEND_CORS_ORIGINS}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_BUCKET=${S3_BUCKET}
      - S3_REGION=${S3_REGION}
      - MAX_UPLOAD_SIZE_MB=${MAX_UPLOAD_SIZE_MB}
      - MAX_IMAGES_PER_SUBMISSION=${MAX_IMAGES_PER_SUBMISSION}
      - PROMETHEUS_ENABLED=${PROMETHEUS_ENABLED}
      - PICRETE_LOG_LEVEL=${PICRETE_LOG_LEVEL}
      - PICRETE_LOG_JSON=${PICRETE_LOG_JSON}
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1536M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  worker:
    build:
      context: .
      dockerfile: Dockerfile
    network_mode: host
    command: ["picrete-worker"]
    environment:
      - POSTGRES_SERVER=localhost
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - FIRST_SUPERUSER_ISU=${FIRST_SUPERUSER_ISU}
      - FIRST_SUPERUSER_PASSWORD=${FIRST_SUPERUSER_PASSWORD}
      - PICRETE_ENV=${PICRETE_ENV}
      - PICRETE_STRICT_CONFIG=${PICRETE_STRICT_CONFIG}
      - REDIS_HOST=localhost
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - SECRET_KEY=${SECRET_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL}
      - AI_MODEL=${AI_MODEL}
      - AI_MAX_TOKENS=${AI_MAX_TOKENS}
      - AI_TEMPERATURE=${AI_TEMPERATURE}
      - AI_REQUEST_TIMEOUT=${AI_REQUEST_TIMEOUT}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_BUCKET=${S3_BUCKET}
      - S3_REGION=${S3_REGION}
      - PROMETHEUS_ENABLED=${PROMETHEUS_ENABLED}
      - PICRETE_LOG_LEVEL=${PICRETE_LOG_LEVEL}
      - PICRETE_LOG_JSON=${PICRETE_LOG_JSON}
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1024M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
